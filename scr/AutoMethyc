#!/bin/bash

#Defect values
thr=4

while [[ $# -gt 0 ]]; do
opt="$1"
shift;
current_arg="$1"
case "$opt" in
"-h"|"--help"      ) echo '''
AutoMethyc version 0.0.1-beta
Usage
	AutoMethyc [options]
Options
	-i --input		Folder with fastq
	-o --output		Output location
	-r --ref		Folder with references
	-f --filtro		File with regions of interest
''';  exit 1;;
"-i"|"--input"      ) input="$1"; shift;;
"-o"|"--output"      ) output="$1"; shift;;
"-r"|"--ref"      ) ref="$1"; shift;;
"-f"|"--filtro"      ) filtro="$1"; shift;;
"-t"|"--threads"      ) thr="$1"; shift;;
	esac
done

BuclePipeline.sh $input $output $ref $thr

# descomprime y renombra los archivos por ID
rename.sh $output/results/06_bedGraph

# Construcción del merge
allmerge.sh $output/results/06_bedGraph $output

# Aplicacion de filtros
python /usr/bin/Filter.py $output/merge.csv $filtro $output

# Construcción del input de ComplexHeatmap
python /usr/bin/Oncoprint.py $output 

rm -rf $output/tmp

echo 'ploting ...'
#Rscript /usr/bin/Oncoprint.R $output/OncoprintRellenado.csv $output/all_sites.png

#Rscript /usr/bin/OncoprintPromedio.R $output/OncoprintPromedio.csv $output/mean.png

python /usr/bin/Report_HTML.py $output/OncoprintRellenado.csv $output/OncoprintPromedio.csv $output/Count.csv $output/NotLoc.csv $output

echo 'Done Report HTML' 

multiqc $output/results/02_fastq_trimmed/*

# Organizando el Output
mkdir $output/CSV
mkdir $output/HTML
mkdir $output/HTML/Bismark_report

mv $output/results/results_html/* $output/HTML/Bismark_report
mv $output/results $output/Bismark 
mv $output/*csv $output/CSV
mv multiqc* $output/HTML
mv $output/*.html $output/HTML

echo 'DONE'
